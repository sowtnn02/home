<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ä½œåœ˜éšŠå‡ºå¸­ç¸½è¦½ (SearchWorkTeam)</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom right, #f9f9f9, #e6f7ff);
      color: #333;
      padding: 40px 20px;
      margin: 0;
      text-align: center;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 30px;
      color: #3c6478;
    }
    a { text-decoration: none; color: inherit; }
    .card {
      background-color: white;
      max-width: 600px;
      margin: 0 auto 20px;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      text-align: left;
    }
    .card label {
      display: block;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .card select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    .card button {
      display: block;
      width: 100%;
      padding: 10px 0;
      margin-top: 10px;
      font-size: 1em;
      color: white;
      background-color: #47a7f5;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .card button:hover {
      background-color: #358ac9;
    }
    
    /* æœå°‹çµæœå®¹å™¨ */
    #results { 
      max-width: 600px; 
      margin: 0 auto; 
      padding: 0; 
      list-style: none; 
      text-align: left;
    }

    /* æœˆä»½/æ´»å‹•æ¨™é¡Œ */
    .sheet-title {
      background: #e0f0ff;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      color: #2a5d9f;
      margin-top: 30px;
      margin-bottom: 10px;
      font-size: 1.1em;
      border-left: 5px solid #2a5d9f;
    }

    /* åœ˜éšŠå€å¡Šæ¨™é¡Œ (å°å¼•åœ˜éšŠ/è‚²æˆæœƒ) */
    .team-category {
      background-color: #f0f8ff;
      color: #333;
      font-weight: bold;
      padding: 8px 12px;
      margin-top: 15px;
      border-bottom: 2px solid #ddd;
      font-size: 1.05em;
    }

    /* äººå“¡åˆ—è¡¨é …ç›® */
    .member-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      background-color: #fff;
      align-items: center;
    }
    .member-row:last-child {
      border-bottom: none;
    }
    
    .member-info {
      display: flex;
      gap: 10px;
    }
    .job-title {
      color: #666;
      font-size: 0.9em;
      min-width: 80px;
    }
    .vol-name {
      font-weight: bold;
      color: #333;
    }

    /* ç‹€æ…‹æ¨£å¼ */
    .status-present { color: green; font-weight: bold; }
    .status-absent  { color: #d9534f; font-weight: bold; }
    .status-unfilled { color: #999; font-style: italic; }
    .status-error { color: orange; }

  </style>
</head>
<body>
  <a href="https://sowtnn02.github.io/home/index"><h1>è’é‡è¦ªå­åœ˜å—äºŒåœ˜ å·¥ä½œåœ˜éšŠå‡ºå¸­ç¸½è¦½</h1></a>
  
  <div class="card">
    <label for="groupSelect">åœ˜åˆ¥</label>
    <select id="groupSelect">
      <option value="">--è«‹é¸æ“‡åœ˜åˆ¥--</option>
      <option value="å°èŸ»åœ˜">å°èŸ»åœ˜</option>
      <option value="ç‚«èœ‚åœ˜">ç‚«èœ‚åœ˜</option>
      <option value="å¥”é¹¿åœ˜">å¥”é¹¿åœ˜</option>
      <option value="ç¿”é·¹åœ˜">ç¿”é·¹åœ˜</option>
    </select>
    <button id="searchBtn">æœå°‹</button>
  </div>

  <div id="results"></div>

  <script src="work-team-data.js"></script>

  <script>
    // ğŸ”´ è¨­å®šåƒæ•¸
    const MY_PROXY_URL = "https://script.google.com/macros/s/AKfycbxmzTs-dGe8rlGjeaUJH44bravhTNccqFsfImSz_wV-bSniF-E1aOqZ6nyShvyVYAtFCQ/exec";
    const MASTER_DB_ID = "13v4T864SSZGSoNiIPGOY12mfzT2q5sbvDrarusC_zLE"; 

    // âœ… åœ˜åˆ¥å°æ‡‰ key (å°æ‡‰ work-team-data.js è£¡çš„ key)
    const groupMap = { 'å°èŸ»åœ˜':'ant', 'ç‚«èœ‚åœ˜':'bee', 'å¥”é¹¿åœ˜':'deer', 'ç¿”é·¹åœ˜':'eagle' };

    // âœ… è³‡æ–™åº«ä¸­çš„å·¥ä½œè¡¨åç¨±
    const sheetNameMap = {
      "å°èŸ»åœ˜": 'èœ‚èŸ»',
      "ç‚«èœ‚åœ˜": 'èœ‚èŸ»',
      "å¥”é¹¿åœ˜": 'é¹¿',
      "ç¿”é·¹åœ˜": 'é·¹'
    };

    // è½‰æ›æˆ GAS Proxy URL
    function toMyProxyUrl(originalUrl) {
      if (!originalUrl) return "";
      const match = originalUrl.match(/\/d\/(.*?)(\/|$)/);
      const targetId = match ? match[1] : "";
      if (!targetId) return "";
      return `${MY_PROXY_URL}?targetId=${targetId}&sheetName=${encodeURIComponent("è¡¨å–®å›æ‡‰ 1")}`;
    }

    // è®€å–ä¸»è³‡æ–™åº«åˆ—è¡¨
    async function loadSheetsFromSheet(sheetName) {
      const url = `${MY_PROXY_URL}?targetId=${MASTER_DB_ID}&sheetName=${encodeURIComponent(sheetName)}`;
      try {
        const res = await fetch(url);
        const raw = await res.json();
        if (raw.error) {
           console.error("Master DB Error", raw);
           alert("ç„¡æ³•è®€å–ä¸»è³‡æ–™è¡¨");
           return [];
        }
        return raw.map(item => ({
          name: `${item.month || ''} ${item.title || ''}`,
          url: toMyProxyUrl(item.response_url || item.form_url)
        }));
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    const groupSelect = document.getElementById('groupSelect');
    const searchBtn = document.getElementById('searchBtn');
    const results = document.getElementById('results');

    searchBtn.addEventListener('click', async () => {
      results.innerHTML = '';
      
      // å®‰å…¨æª¢æŸ¥
      if (typeof workteamData === 'undefined') {
        alert("âš ï¸ ç„¡æ³•è®€å–åå–®è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– work-team-data.js è·¯å¾‘ã€‚");
        return;
      }

      const grp = groupSelect.value.trim();
      if (!grp) return alert('è«‹é¸æ“‡åœ˜åˆ¥');

      const key = groupMap[grp];
      const masterSheetName = sheetNameMap[grp];

      if (!masterSheetName) return alert('æŸ¥ç„¡å°æ‡‰è³‡æ–™è¡¨ä¾†æº');

      results.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">â³ æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...</div>';

      const teamCategories = Object.keys(workteamData[key]);
      const sheets = await loadSheetsFromSheet(masterSheetName);

      results.innerHTML = '';

      if (sheets.length === 0) {
        results.innerHTML = '<div style="text-align:center; padding:20px;">âš ï¸ æ‰¾ä¸åˆ°ä»»ä½•è¡¨å–®ç´€éŒ„ï¼Œè«‹ç¢ºèªè³‡æ–™åº«ã€‚</div>';
        return;
      }

      // --- é–‹å§‹é€ä¸€è™•ç†æ¯å€‹æ´»å‹•è¡¨å–® ---
      for (const sheet of sheets) {
        if (!sheet.url || sheet.url.includes("targetId=&")) continue;

        // å»ºç«‹è©²æœˆä»½çš„å€å¡Š
        const sheetBlock = document.createElement('div');
        sheetBlock.innerHTML = `<div class="sheet-title">${sheet.name}</div>`;
        results.appendChild(sheetBlock);

        let formData = [];
        try {
          const resp = await fetch(sheet.url + '&t=' + Date.now(), { cache:'no-store' });
          formData = await resp.json();
          if (formData.error) throw new Error(formData.error);
        } catch {
          sheetBlock.innerHTML += `<div style="padding:10px; color:red;">âš ï¸ æŸ¥è©¢å¤±æ•— (é€£ç·šé€¾æ™‚æˆ–æ¬Šé™éŒ¯èª¤)</div>`;
          continue;
        }

        // --- å»ºç«‹å¿«é€ŸæŸ¥æ‰¾è¡¨ (Mapping) ---
        const submissionMap = {};
        formData.forEach(row => {
          const vals = Object.values(row); 
          // Index 1 = Bæ¬„ (Family)
          const famName = (vals[1] || "").trim();
          if (famName) {
            submissionMap[famName] = vals;
          }
        });

        // --- é€ä¸€è™•ç†è©²åœ˜çš„å­åœ˜éšŠ ---
        for (const catName of teamCategories) {
          const members = workteamData[key][catName];
          
          const catDiv = document.createElement('div');
          catDiv.innerHTML = `<div class="team-category">${catName}</div>`;
          sheetBlock.appendChild(catDiv);

          members.forEach(member => {
            const memFamily = member.family.trim();
            const memVol = member.volunteer.trim();
            const memTitle = member.title.trim();

            let statusHtml = '<span class="status-unfilled">å°šæœªå¡«å¯«</span>';
            
            // 1. æª¢æŸ¥æ˜¯å¦åœ¨ B æ¬„ (submissionMap)
            if (submissionMap[memFamily]) {
              const rowVals = submissionMap[memFamily];

              // ğŸ”´ ç‰¹ä¾‹è™•ç†ï¼šç¿”é·¹åœ˜å‰¯åœ˜é•·ï¼ˆå°é·¹ï¼‰
              if (memTitle === "å‰¯åœ˜é•·ï¼ˆå°é·¹ï¼‰") {
                // é‚è¼¯ï¼š
                // Cæ¬„(Index 2) å«å¿—å·¥å -> çµæœåœ¨ Eæ¬„(Index 4)
                // Fæ¬„(Index 5) å«å¿—å·¥å -> çµæœåœ¨ Hæ¬„(Index 7)
                // Iæ¬„(Index 8) å«å¿—å·¥å -> çµæœåœ¨ Kæ¬„(Index 10)
                
                const cVal = (rowVals[2] || "").toString();
                const fVal = (rowVals[5] || "").toString();
                const iVal = (rowVals[8] || "").toString();

                let foundStatus = "";
                
                if (cVal.includes(memVol)) {
                    foundStatus = (rowVals[4] || "å‡ºå¸­").trim();
                } else if (fVal.includes(memVol)) {
                    foundStatus = (rowVals[7] || "å‡ºå¸­").trim();
                } else if (iVal.includes(memVol)) {
                    foundStatus = (rowVals[10] || "å‡ºå¸­").trim();
                }

                if (foundStatus) {
                   if (foundStatus.includes("å‡ºå¸­")) {
                     statusHtml = `<span class="status-present">${foundStatus}</span>`;
                   } else if (foundStatus.includes("å‡")) {
                     statusHtml = `<span class="status-absent">${foundStatus}</span>`;
                   } else {
                     statusHtml = `<span class="status-unfilled">${foundStatus}</span>`;
                   }
                } else {
                   // æœ‰å¡«å®¶åº­ï¼Œä½†æ²’åœ¨ C/F/I æ‰¾åˆ°é€™åå­— (å¯èƒ½å¡«åœ¨å…¶ä»–æ¬„ä½æˆ–æ²’é¸)
                   statusHtml = '<span class="status-unfilled">æœªå‹¾é¸</span>';
                }

              } else {
                // ğŸ”µ ä¸€èˆ¬å·¥ä½œäººå“¡é‚è¼¯ (åŸé‚è¼¯)
                // Læ¬„(Index 11) å‡ºå¸­
                // Mæ¬„(Index 12) è«‹å‡
                const attendStr = (rowVals[11] || "").toString();
                const leaveStr  = (rowVals[12] || "").toString();

                if (attendStr.includes(memVol)) {
                  statusHtml = '<span class="status-present">å‡ºå¸­</span>';
                } else if (leaveStr.includes(memVol)) {
                  statusHtml = '<span class="status-absent">è«‹å‡</span>';
                } else {
                  statusHtml = '<span class="status-unfilled">æœªå‹¾é¸</span>';
                }
              }
            }

            // è¼¸å‡ºè©²å“¡åˆ—
            const rowDiv = document.createElement('div');
            rowDiv.className = 'member-row';
            rowDiv.innerHTML = `
              <div class="member-info">
                <span class="job-title">${memTitle}</span>
                <span class="vol-name">${memVol}</span>
              </div>
              <div>${statusHtml}</div>
            `;
            sheetBlock.appendChild(rowDiv);
          });
        }
      }
    });
  </script>
</body>
</html>
