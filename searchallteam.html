<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å„åˆ†åœ˜å‡ºå¸­ç¸½è¦½ (SearchAll)</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom right, #f9f9f9, #e6f7ff);
      color: #333;
      padding: 40px 20px;
      margin: 0;
      text-align: center;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 30px;
      color: #3c6478;
    }
    .card {
      background-color: white;
      max-width: 500px;
      margin: 0 auto 20px;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      text-align: left;
    }
    .card label {
      display: block;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .card select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    .card button {
      display: block;
      width: 100%;
      padding: 10px 0;
      margin-top: 10px;
      font-size: 1em;
      color: white;
      background-color: #47a7f5;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .card button:hover {
      background-color: #358ac9;
    }
    ul#results { list-style: none; padding: 0; margin: 0; }
    ul#results li {
      padding: 8px;
      margin: 6px auto;
      max-width: 500px;
      border-radius: 8px;
      background-color: #f1f8ff;
      border-left: 6px solid #47a7f5;
      text-align: left;
      font-size: 1em;
    }
    .status-present { color: green; font-weight: bold; }
    .status-absent  { color: red; font-weight: bold; }
    .status-unfilled { color: gray; font-style: italic; }
  </style>
</head>
<body>
  <a href="https://sowtnn02.github.io/home/index"><h1>è’é‡è¦ªå­åœ˜å—äºŒåœ˜ å„åˆ†åœ˜å‡ºå¸­ç¸½è¦½</h1></a>
  <div class="card">
    <label for="groupSelect">åœ˜åˆ¥</label>
    <select id="groupSelect">
      <option value="">--è«‹é¸æ“‡åœ˜åˆ¥--</option>
      <option value="å°èŸ»åœ˜">å°èŸ»åœ˜</option>
      <option value="ç‚«èœ‚åœ˜">ç‚«èœ‚åœ˜</option>
      <option value="å¥”é¹¿åœ˜">å¥”é¹¿åœ˜</option>
      <option value="ç¿”é·¹åœ˜">ç¿”é·¹åœ˜</option>
    </select>
    <button id="searchBtn">æœå°‹</button>
  </div>
  <ul id="results"></ul>

<script src="https://sowtnn02.github.io/home/team-data.js"></script>

  <script>
    // ğŸ”´ 2. è¨­å®šä½ çš„ GAS ç¶²å€ (è¬ç”¨æŸ¥è©¢å™¨)
    const MY_PROXY_URL = "https://script.google.com/macros/s/AKfycbxmzTs-dGe8rlGjeaUJH44bravhTNccqFsfImSz_wV-bSniF-E1aOqZ6nyShvyVYAtFCQ/exec";

    // ğŸ”´ 3. è¨­å®šä½ çš„ä¸»è³‡æ–™åº« ID (å·²æ›´æ–°)
    const MASTER_DB_ID = "1rsQZORmQldGeco9YRNUn9jaO10ogvXpsVSqjk4Z8Ur0"; 

    // âœ… åœ˜åˆ¥å°æ‡‰ key (å°æ‡‰ team-data.js è£¡çš„ key)
    const groupMap = { 'å°èŸ»åœ˜':'ant','ç‚«èœ‚åœ˜':'bee','å¥”é¹¿åœ˜':'deer','ç¿”é·¹åœ˜':'eagle' };

    // âœ… è³‡æ–™åº«ä¸­çš„å·¥ä½œè¡¨åç¨± (å°æ‡‰æ–°è¡¨å–®çš„åˆ†é )
    const sheetNameMap = {
      "å°èŸ»åœ˜": 'èœ‚èŸ»',
      "ç‚«èœ‚åœ˜": 'èœ‚èŸ»',
      "å¥”é¹¿åœ˜": 'é¹¿',
      "ç¿”é·¹åœ˜": 'é·¹'
    };

    // è½‰æ›æˆ GAS Proxy URL
    function toMyProxyUrl(originalUrl) {
      if (!originalUrl) return "";
      const match = originalUrl.match(/\/d\/(.*?)(\/|$)/);
      const targetId = match ? match[1] : "";
      if (!targetId) return "";
      return `${MY_PROXY_URL}?targetId=${targetId}&sheetName=${encodeURIComponent("è¡¨å–®å›æ‡‰ 1")}`;
    }

    // è®€å–ä¸»è³‡æ–™åº«åˆ—è¡¨ (å«æ—¥æœŸéæ¿¾)
    async function loadSheetsFromSheet(sheetName) {
      const url = `${MY_PROXY_URL}?targetId=${MASTER_DB_ID}&sheetName=${encodeURIComponent(sheetName)}`;
      try {
        const res = await fetch(url);
        const raw = await res.json();
        if (raw.error) {
           console.error("Master DB Error", raw);
           alert("ç„¡æ³•è®€å–ä¸»è³‡æ–™è¡¨");
           return [];
        }

        // --- ğŸŸ¢ æ–°å¢ï¼šæ—¥æœŸéæ¿¾é‚è¼¯ ---
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const validData = raw.filter(item => {
           // 1. æª¢æŸ¥ä¸Šæ¶æ—¥
           if (item.date) {
             const startDate = new Date(item.date);
             startDate.setHours(0, 0, 0, 0);
             if (startDate > today) return false; 
           }
           // 2. æª¢æŸ¥ä¸‹æ¶æ—¥
           if (item.expiryDate) {
             const endDate = new Date(item.expiryDate);
             endDate.setHours(0, 0, 0, 0);
             if (endDate < today) return false; 
           }
           return true;
        });

        return validData.map(item => ({
          name: `${item.month || ''} ${item.title || ''}`,
          url: toMyProxyUrl(item.response_url || item.form_url)
        }));
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    const groupSelect = document.getElementById('groupSelect');
    const searchBtn = document.getElementById('searchBtn');
    const results = document.getElementById('results');

    searchBtn.addEventListener('click', async () => {
      results.innerHTML = '';
      
      if (typeof teamData === 'undefined') {
        alert("âš ï¸ ç„¡æ³•è®€å–åå–®è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– team-data.js è·¯å¾‘ã€‚");
        return;
      }

      const grp = groupSelect.value.trim();
      if (!grp) return alert('è«‹é¸æ“‡åœ˜åˆ¥');

      const key = groupMap[grp];
      const masterSheetName = sheetNameMap[grp];

      if (!masterSheetName) return alert('æŸ¥ç„¡å°æ‡‰è³‡æ–™è¡¨ä¾†æº');

      results.innerHTML = '<li style="text-align:center; color:#666;">â³ æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...</li>';

      const allSubGroups = Object.keys(teamData[key]);
      const sheets = await loadSheetsFromSheet(masterSheetName);

      results.innerHTML = '';

      if (sheets.length === 0) {
        results.innerHTML = '<li>âš ï¸ æ‰¾ä¸åˆ°ä»»ä½•è¡¨å–®ç´€éŒ„ï¼Œæˆ–æ˜¯ç›®å‰ç„¡é–‹æ”¾çš„è¡¨å–®ã€‚</li>';
        return;
      }

      for (const sheet of sheets) {
        if (!sheet.url || sheet.url.includes("targetId=&")) continue;

        results.innerHTML += `
          <li style="
            background:#e0f0ff;
            padding:10px;
            border-radius:8px;
            font-weight:bold;
            color:#2a5d9f;
            margin-top:20px
          ">
            ${sheet.name}ï½œ${grp}å‡ºå¸­ç‹€æ³ï¼š
          </li>`;

        for (const sub of allSubGroups) {
          const entries = teamData[key][sub];
          const statusMap = {};
          entries.forEach(e => {
            const k = `${e.family.trim()}|${e.child.trim()}`;
            statusMap[k] = { ...e, filled:false, submitted:false, status:'' };
          });

          let data;
          try {
            const resp = await fetch(sheet.url + '&t=' + Date.now(), { cache:'no-store' });
            data = await resp.json();
            if (data.error) throw new Error(data.error);
          } catch {
            results.innerHTML += `<li>${sub}ï¼šâš ï¸ æŸ¥è©¢å¤±æ•— (é€£ç·šé€¾æ™‚æˆ–æ¬Šé™éŒ¯èª¤)</li>`;
            continue;
          }

          data.forEach(row => {
            const vals = Object.values(row);
            const fam = (vals[1] || '').trim();
            
            entries.forEach(e => {
              if (fam !== e.family.trim()) return;
              for (let i = 0; i < 3; i++) {
                const child = (vals[2 + i*3] || '').trim();
                const squad = (vals[3 + i*3] || '').trim();
                const st = (vals[4 + i*3] || 'å‡ºå¸­').trim();
                
                if (squad === sub || squad === grp) {
                  const k = `${e.family.trim()}|${e.child.trim()}`;
                  statusMap[k] = { ...statusMap[k], filled:true, submitted:true, status:st };
                }
              }
            });
          });

          results.innerHTML += `<li style="background:#f9fbff;font-weight:bold;margin-top:10px;">ğŸŸ¢ ${sub}</li>`;
          entries.forEach(e => {
            const k = `${e.family.trim()}|${e.child.trim()}`;
            const s = statusMap[k];
            let line;
            if (s.filled) {
              const ok = s.status.includes('å‡ºå¸­');
              line = `${s.family} _ ${s.child}ï¼š<span class="${ok?'status-present':'status-absent'}">${ok?'âœ… å‡ºå¸­':'âŒ è«‹å‡'}</span>`;
            } else if (s.submitted) {
              line = `${s.family} _ ${s.child}ï¼š<span class="status-unfilled">âš ï¸ æœ‰å¡«è¡¨ï¼Œä½†æœªå¡«æ­¤å°éšŠ</span>`;
            } else {
              line = `${s.family} _ ${s.child}ï¼š<span class="status-unfilled">æœªå¡«å¯«</span>`;
            }
            results.innerHTML += `<li>${line}</li>`;
          });
        }
      }
    });
</script>
</body>
</html>
